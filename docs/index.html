<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Elshaday Yoseph">
<meta name="dcterms.date" content="2025-01-15">

<title>How Does ChatGPT Drink Water? The Hidden Cost of AI Models – Home</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Home</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About This Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/elshaday-tamire-yoseph/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Elshaday-Tamire"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#the-science-behind-ai-water-consumption" id="toc-the-science-behind-ai-water-consumption" class="nav-link" data-scroll-target="#the-science-behind-ai-water-consumption">The Science Behind AI Water Consumption</a></li>
  <li><a href="#real-world-data-quantifying-the-impact" id="toc-real-world-data-quantifying-the-impact" class="nav-link" data-scroll-target="#real-world-data-quantifying-the-impact">Real-World Data (Quantifying the Impact)</a></li>
  <li><a href="#broader-implications-for-sustainability" id="toc-broader-implications-for-sustainability" class="nav-link" data-scroll-target="#broader-implications-for-sustainability">Broader Implications for Sustainability</a></li>
  <li><a href="#steps-toward-sustainable-ai" id="toc-steps-toward-sustainable-ai" class="nav-link" data-scroll-target="#steps-toward-sustainable-ai">Steps Toward Sustainable AI</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">How Does ChatGPT Drink Water? The Hidden Cost of AI Models</h1>
  <div class="quarto-categories">
    <div class="quarto-category">AI</div>
    <div class="quarto-category">Sustainability</div>
    <div class="quarto-category">Technology</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Elshaday Yoseph </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 15, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Did you know that every conversation with ChatGPT comes with a surprising hidden cost? While these AI models don’t literally drink water, they’re actually significant water consumers thanks to the massive data centers that power them.</p>
<p>Behind every AI response lies a fascinating process: enormous data centers packed with powerful computers work intensively to analyze your question and generate an answer. These machines run hot – very hot. To prevent overheating, they need constant cooling, and that’s where water plays its crucial role. Traditional cooling systems use millions of gallons of water to keep these digital brains running smoothly.</p>
<p>The scale of this water usage is remarkable. Training a large language model can consume as much water as manufacturing several cars. And it doesn’t stop there – every time we interact with these AI systems, more computing power is needed, requiring more cooling and, consequently, more water. This creates an interesting paradox: while AI helps us solve complex problems and improve efficiency in many areas, it also places a growing demand on one of our most precious resources.</p>
<p>This blog explores the unexpected relationship between AI and water consumption, focusing particularly on ChatGPT as an example. We’ll examine how these systems actually use water, what this means for our environment, and the innovative solutions being developed to address this challenge. Understanding this connection is becoming increasingly important as AI continues to integrate into our daily lives and reshape our technological landscape.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/image.png" class="img-fluid figure-img" width="500"></p>
<figcaption>Cooling the Brain: Chatgpt drinks water!</figcaption>
</figure>
</div>
<hr>
</section>
<section id="the-science-behind-ai-water-consumption" class="level2">
<h2 class="anchored" data-anchor-id="the-science-behind-ai-water-consumption">The Science Behind AI Water Consumption</h2>
<p>Understanding how AI uses water starts with a journey inside a modern data center – imagine a warehouse-sized building filled with thousands of powerful computers, all working in perfect harmony. These aren’t your everyday laptops; they’re industrial-grade servers that form the backbone of AI operations. Let’s break down exactly why and how these systems are so thirsty.</p>
<p><strong>The Cooling Challenge (Keeping AI’s Brain from Overheating)</strong></p>
<p>When you ask ChatGPT a question, hundreds of processors spring into action, performing trillions of calculations per second. All this computational work generates an enormous amount of heat – enough to damage or destroy the equipment if left unchecked. To put this in perspective, a single AI server can generate more heat than ten household ovens running at full blast.</p>
<p>This is where water enters the picture. Modern data centers employ sophisticated cooling systems that work in several ways:</p>
<ul>
<li><strong>Direct Water Cooling</strong>: Cold water pipes run directly through server racks, absorbing heat like a car’s radiator.</li>
<li><strong>Evaporative Cooling</strong>: Water is sprayed into the air, creating a cooling effect as it evaporates.</li>
<li><strong>Chiller Systems</strong>: Massive industrial chillers use water to remove heat from the building, much like your home air conditioner but on a massive scale.</li>
</ul>
<p><strong>The Power Behind the Processing (Water’s Hidden Role)</strong></p>
<p>But cooling is only half the story. Before a single calculation happens, water has already played a crucial role in powering these facilities. Here’s how:</p>
<ul>
<li><strong>Power Generation</strong>: Most electricity still comes from traditional power plants, where water boils to create steam that spins turbines (<a href="https://www.gstatic.com/gumdrop/sustainability/google-2022-environmental-report.pdf">Google Environmental Report 2022</a>).</li>
<li><strong>Power Plant Cooling</strong>: After generating electricity, these plants need massive amounts of water to cool down their systems.</li>
<li><strong>Transmission</strong>: Even the process of transmitting electricity to data centers involves equipment that requires cooling.</li>
</ul>
<p>A Complex Water Web:</p>
<ul>
<li>A typical coal or nuclear power plant uses 20–60 gallons of water to generate one kilowatt-hour of electricity (<a href="https://eta.lbl.gov/publications/united-states-data-center-energy">Current Developments in Cooling</a>).</li>
<li>Large data centers can consume as much electricity as a small city.</li>
<li>The combination of power generation and cooling means each AI query has a larger water footprint than most people realize.</li>
</ul>
<p><strong>Measuring the Impact</strong></p>
<p>To understand the scale, consider these numbers:</p>
<ul>
<li>A typical data center uses 3–5 million gallons of water per day.</li>
<li>The cooling systems alone can account for 40% of a data center’s electricity usage.</li>
<li>In hot climates or during summer months, water consumption can increase by up to 50% (<a href="https://www.gstatic.com/gumdrop/sustainability/google-2022-environmental-report.pdf">Google Environmental Report 2022</a>).</li>
</ul>
<p><strong>The Regional Challenge</strong></p>
<p>The impact of this water usage varies significantly by location:</p>
<ul>
<li>Cold regions like Norway or Iceland naturally require less cooling.</li>
<li>Arid regions face greater challenges, as water is already scarce.</li>
<li>Coastal locations might use seawater for cooling, reducing freshwater consumption.</li>
</ul>
<p>This complex relationship between AI computing, power generation, and cooling systems creates a significant water footprint that extends far beyond the visible infrastructure. Understanding these connections is crucial for developing more sustainable solutions and making informed decisions about AI deployment and use.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/image1.png" class="img-fluid figure-img" width="500"></p>
<figcaption>Flow of resources: AI computation → Heat generation → Cooling systems using water</figcaption>
</figure>
</div>
<hr>
</section>
<section id="real-world-data-quantifying-the-impact" class="level2">
<h2 class="anchored" data-anchor-id="real-world-data-quantifying-the-impact">Real-World Data (Quantifying the Impact)</h2>
<p>The numbers behind AI’s water usage are eye-opening. Imagine a standard Olympic swimming pool – now picture filling and draining it every single day. That’s roughly how much water a large data center uses just for cooling. To put this into perspective, while you’re reading this sentence, data centers around the world are using more water than a typical household uses in a month.</p>
<p>Let’s look at some concrete examples. Google, one of the tech giants powering numerous AI systems, used a staggering <a href="https://www.gstatic.com/gumdrop/sustainability/google-2022-environmental-report.pdf">15.79 billion gallons of water</a> in 2022 for their data centers. That’s enough water to fill nearly 24,000 Olympic-sized swimming pools, or to provide drinking water to a city of 300,000 people for an entire year.</p>
<p>The energy demands are equally striking. Training a sophisticated AI model like GPT-3 requires an enormous amount of computing power. To understand the scale: the energy needed to train just one of these models could power several thousand American homes for a year. That’s equivalent to leaving your television on for over 800 years straight, or charging your smartphone every day for the next 5,000 years (<a href="https://www.cbre.com/insights/articles/the-future-of-data-center-operations">Studies on Data Centers</a>).</p>
<p>These numbers aren’t just statistics – they represent real resources being used in real places, often in regions where water scarcity is already a pressing concern. This consumption raises important questions about how we balance technological advancement with environmental responsibility, especially as our reliance on AI continues to grow.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/image2.png" class="img-fluid figure-img" width="500"></p>
<figcaption>Comparison of water usage in AI training and other industries</figcaption>
</figure>
</div>
<hr>
</section>
<section id="broader-implications-for-sustainability" class="level2">
<h2 class="anchored" data-anchor-id="broader-implications-for-sustainability">Broader Implications for Sustainability</h2>
<p>When we talk about water and AI, we’re not just discussing tech industry challenges – we’re touching on one of the most pressing issues of our time. Picture Earth from space: that beautiful blue marble has a limited supply of freshwater, and we’re already pushing those limits.</p>
<p>As AI technology grows, it’s creating an interesting dilemma. While these systems help us solve complex problems like climate modeling and efficient resource use, they’re also adding pressure to our water resources. It’s a bit like using water to find ways to save water – there’s an inherent tension there.</p>
<p>In many parts of the world, getting clean water is already a daily struggle for millions of people. The tech boom, including AI development, adds another competitor for this precious resource. Meanwhile, climate change is making water supplies even less predictable. When data centers set up shop in water-stressed regions, they’re essentially pulling from the same water bucket as local communities and farms (<a href="https://eta.lbl.gov/publications/united-states-data-center-energy">Current Developments in Cooling</a>).</p>
<p>But there’s hope on the horizon. The shift to renewable energy could be a game-changer. Solar and wind power typically use far less water than traditional power plants, offering a path to reduce AI’s thirst.</p>
<hr>
</section>
<section id="steps-toward-sustainable-ai" class="level2">
<h2 class="anchored" data-anchor-id="steps-toward-sustainable-ai">Steps Toward Sustainable AI</h2>
<p>The good news is that smart people around the world are working on creative solutions to make AI more sustainable. Here’s what’s happening:</p>
<ul>
<li><p>Engineers are developing cooling systems that are more clever than ever. Some data centers are experimenting with liquid cooling – imagine submerging servers in special non-conducting fluids that are far more efficient than water. Others are using advanced air cooling systems in cold climates, literally letting nature do the heavy lifting.</p></li>
<li><p>The energy piece of the puzzle is changing too. Tech companies are increasingly powering their data centers with renewable energy. Microsoft, Google, and others have made bold commitments to use 100% renewable energy, which naturally leads to lower water consumption (<a href="https://www.gstatic.com/gumdrop/sustainability/google-2022-environmental-report.pdf">Google Environmental Report 2022</a>).</p></li>
<li><p>Perhaps most exciting are the breakthroughs in AI efficiency itself. Researchers are finding ways to train AI models that require less computational power – and therefore less cooling – while maintaining or even improving performance. It’s like teaching a car to go further on less fuel.</p></li>
</ul>
<p>These solutions aren’t just theoretical – they’re being implemented right now, showing that technological progress doesn’t have to come at the environment’s expense. As these innovations continue to develop, they’re paving the way for more sustainable AI that can help solve global challenges without creating new ones.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/image3.png" class="img-fluid figure-img" width="500"></p>
<figcaption>Sustainable AI practices: solar-powered data centers, efficient cooling systems, and optimized AI training</figcaption>
</figure>
</div>
<hr>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The AI revolution is changing our world in remarkable ways. ChatGPT and similar AI models help us write, solve problems, and even create art – but every technological leap comes with responsibility. By understanding the hidden water costs behind our AI interactions, we can make smarter choices about how we develop and use these powerful tools.</p>
<p>The story of AI and water teaches us an important lesson: innovation doesn’t happen in a vacuum. Every line of code, every query processed, and every response generated creates ripples that extend far beyond our screens. The good news is that awareness is growing, and the tech industry is responding with innovative solutions that could make AI both more powerful and more sustainable.</p>
<p>As we move forward, each of us has a role to play. Users can make informed choices about their AI usage. Tech companies can prioritize sustainable practices in their development. Policymakers can create frameworks that encourage responsible innovation. Together, we can ensure that the future of AI aligns with the future of our planet.</p>
<p>The journey toward sustainable AI isn’t just about preserving resources – it’s about proving that human ingenuity can solve problems without creating new ones. As we continue to push the boundaries of what AI can do, let’s make sure we’re moving toward a future that’s not only smarter but also more sustainable.</p>
<hr>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://www.gstatic.com/gumdrop/sustainability/google-2022-environmental-report.pdf">Google Environmental Report 2022</a></li>
<li><a href="https://www.cbre.com/insights/articles/the-future-of-data-center-operations">Studies on Data Center Operations</a></li>
<li><a href="https://eta.lbl.gov/publications/united-states-data-center-energy">Current Developments in Cooling Technologies</a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>